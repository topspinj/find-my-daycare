{% extends "base.html" %}

{% block title %}Search Results - Find My Daycare{% endblock %}

{% block content %}
<div class="results-container">
    <!-- Navigation bar -->
    <nav class="results-nav">
        <div class="nav-content">
            <div class="nav-left">
                <a href="/" class="back-link">
                    <span>&larr;</span>
                    <span>New search</span>
                </a>
                <div class="search-context">
                    <strong id="results-count">{{ results|length }}</strong> daycares within 5 km of <strong>{{ address }}</strong>
                    <span>&middot;</span>
                    {{ age_display }} on {{ start_date_display }} ({{ results[0].age_group_label if results else 'N/A' }})
                </div>
            </div>

            {% if results %}
            <div class="filter-pills">
                <button class="filter-pill" id="filter-walking" type="button">
                    <span class="count">{{ stats.walking_distance }}</span>
                    <span>walking</span>
                </button>
                <button class="filter-pill" id="filter-cwelcc" type="button">
                    <span class="count">{{ stats.cwelcc_count }}</span>
                    <span>CWELCC</span>
                </button>
                <button class="filter-pill shortlist-btn" id="open-shortlist" type="button">
                    <i class="fa-solid fa-heart"></i>
                    <span id="shortlist-count">0</span>
                    <span>saved</span>
                </button>
            </div>
            {% endif %}
        </div>
    </nav>

    {% if results %}
    <div class="results-main">
        <div class="results-layout">
            <div class="sidebar">
                <div class="daycare-grid">
                    {% for daycare in results %}
                    <article class="profile-card"
                             data-loc-id="{{ daycare.loc_id }}"
                             data-lat="{{ daycare.lat }}"
                             data-lon="{{ daycare.lon }}"
                             data-cwelcc="{{ 'true' if daycare.cwelcc else 'false' }}"
                             data-walktime="{{ daycare.walk_time }}">

                        <div class="card-header">
                            <div class="card-header-left">
                                <h3 class="card-title">{{ daycare.name }}</h3>
                                <p class="card-address">{{ daycare.address }}, {{ daycare.postal_code }}</p>
                            </div>
                            <div class="card-header-right">
                                <button class="bookmark-btn" type="button" title="Save to shortlist">
                                    <i class="fa-regular fa-heart"></i>
                                </button>
                                <span class="card-distance">{{ daycare.distance_km }} km</span>
                            </div>
                        </div>

                        <div class="travel-chips">
                            {% if daycare.walk_time %}
                            <span class="travel-chip">
                                <i class="fa-solid fa-person-walking"></i>
                                {{ daycare.walk_time }}
                            </span>
                            <span class="travel-chip">
                                <i class="fa-solid fa-car"></i>
                                {{ daycare.drive_time }}
                            </span>
                            {% endif %}
                        </div>

                        <div class="capacity-section">
                            <div class="capacity-title">Spaces by age</div>
                            <div class="capacity-grid">
                                <div class="capacity-item {% if 'Infant' in daycare.age_group_label %}highlighted{% endif %}">
                                    <div class="age-label">Infant</div>
                                    <div class="spaces">{{ daycare.infant_spaces }}</div>
                                </div>
                                <div class="capacity-item {% if 'Toddler' in daycare.age_group_label %}highlighted{% endif %}">
                                    <div class="age-label">Toddler</div>
                                    <div class="spaces">{{ daycare.toddler_spaces }}</div>
                                </div>
                                <div class="capacity-item {% if 'Preschool' in daycare.age_group_label %}highlighted{% endif %}">
                                    <div class="age-label">Preschool</div>
                                    <div class="spaces">{{ daycare.preschool_spaces }}</div>
                                </div>
                                <div class="capacity-item {% if 'Kindergarten' in daycare.age_group_label %}highlighted{% endif %}">
                                    <div class="age-label">Kinder</div>
                                    <div class="spaces">{{ daycare.kindergarten_spaces }}</div>
                                </div>
                                <div class="capacity-item {% if 'School Age' in daycare.age_group_label %}highlighted{% endif %}">
                                    <div class="age-label">School</div>
                                    <div class="spaces">{{ daycare.schoolage_spaces }}</div>
                                </div>
                            </div>
                        </div>

                        {% if daycare.website or daycare.google_rating or daycare.phone %}
                        <div class="supplementary-info">
                            {% if daycare.google_rating %}
                            <span class="rating-chip">
                                <i class="fa-brands fa-google"></i>
                                <i class="fa-solid fa-star"></i>
                                {{ daycare.google_rating }}
                                {% if daycare.google_reviews_count %}
                                <span class="review-count">({{ daycare.google_reviews_count }})</span>
                                {% endif %}
                            </span>
                            {% endif %}
                            {% if daycare.website %}
                            <a href="{{ daycare.website }}" target="_blank" rel="noopener" class="website-link">
                                <i class="fa-solid fa-globe"></i>
                                Website
                            </a>
                            {% endif %}
                            {% if daycare.phone %}
                            <a href="tel:{{ daycare.phone }}" class="phone-link">
                                <i class="fa-solid fa-phone"></i>
                                {{ daycare.phone }}
                            </a>
                            {% endif %}
                        </div>
                        {% endif %}

                        <div class="card-footer">
                            <div class="card-badges">
                                {% if daycare.cwelcc %}
                                <span class="badge cwelcc">CWELCC</span>
                                {% endif %}
                                {% if daycare.subsidy %}
                                <span class="badge subsidy">Subsidy</span>
                                {% endif %}
                            </div>
                            <span class="total-spaces">{{ daycare.total_spaces }} total spaces</span>
                        </div>
                    </article>
                    {% endfor %}
                </div>
            </div>

            <div class="map-container">
                <div id="map"></div>
            </div>
        </div>
    </div>

    <!-- Shortlist Panel -->
    <div id="shortlist-overlay" class="shortlist-overlay"></div>
    <div id="shortlist-panel" class="shortlist-panel">
        <div class="shortlist-header">
            <h3>My Shortlist</h3>
            <button id="close-shortlist-btn" class="close-btn" type="button">
                <i class="fa-solid fa-times"></i>
            </button>
        </div>
        <div id="shortlist-items" class="shortlist-items"></div>
        <div class="shortlist-footer">
            <div class="email-form">
                <input type="email" id="shortlist-email" placeholder="Enter your email" />
                <button id="send-shortlist-btn" class="send-btn" type="button">Send to my email</button>
            </div>
            <div id="email-status" class="email-status"></div>
            <button id="clear-shortlist-btn" class="clear-btn" type="button">Clear all</button>
        </div>
    </div>

    <script>
        var map = L.map('map').setView([{{ user_lat }}, {{ user_lon }}], 14);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://carto.com/">CARTO</a>'
        }).addTo(map);

        // User location marker
        var userIcon = L.divIcon({
            className: 'user-marker',
            html: '<span style="font-size:28px;">üìç</span>',
            iconSize: [28, 28],
            iconAnchor: [14, 28],
            popupAnchor: [0, -28]
        });
        L.marker([{{ user_lat }}, {{ user_lon }}], {icon: userIcon})
            .addTo(map)
            .bindPopup('<strong>Your location</strong><br>{{ address }}');

        // CWELCC marker (blue)
        var cwelccIcon = L.divIcon({
            className: 'cwelcc-marker',
            html: '<div style="background:#2563eb;width:28px;height:28px;border-radius:50%;border:2px solid white;box-shadow:0 2px 4px rgba(0,0,0,0.2);display:flex;align-items:center;justify-content:center;"><i class="fa-solid fa-baby" style="color:white;font-size:12px;"></i></div>',
            iconSize: [28, 28],
            iconAnchor: [14, 14],
            popupAnchor: [0, -14]
        });

        // Non-CWELCC marker (orange)
        var nonCwelccIcon = L.divIcon({
            className: 'non-cwelcc-marker',
            html: '<div style="background:#f97316;width:28px;height:28px;border-radius:50%;border:2px solid white;box-shadow:0 2px 4px rgba(0,0,0,0.2);display:flex;align-items:center;justify-content:center;"><i class="fa-solid fa-baby" style="color:white;font-size:12px;"></i></div>',
            iconSize: [28, 28],
            iconAnchor: [14, 14],
            popupAnchor: [0, -14]
        });

        // Legend
        var legend = L.control({position: 'bottomright'});
        legend.onAdd = function(map) {
            var div = L.DomUtil.create('div', 'map-legend');
            div.innerHTML = `
                <div style="background:white;padding:10px 12px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1);font-size:12px;font-family:-apple-system,sans-serif;">
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
                        <div style="background:#2563eb;width:12px;height:12px;border-radius:50%;"></div>
                        <span style="color:#37352f;">CWELCC</span>
                    </div>
                    <div style="display:flex;align-items:center;gap:8px;">
                        <div style="background:#f97316;width:12px;height:12px;border-radius:50%;"></div>
                        <span style="color:#37352f;">Non-CWELCC</span>
                    </div>
                </div>
            `;
            return div;
        };
        legend.addTo(map);

        // Search address for shortlist
        var searchAddress = "{{ address | e }}";

        // Daycare data
        var daycares = [
            {% for daycare in results %}
            {
                locId: {{ daycare.loc_id }},
                lat: {{ daycare.lat }},
                lon: {{ daycare.lon }},
                name: "{{ daycare.name | e }}",
                address: "{{ daycare.address | e }}",
                postalCode: "{{ daycare.postal_code | e }}",
                phone: "{{ daycare.phone | e }}",
                distanceKm: {{ daycare.distance_km }},
                totalSpaces: {{ daycare.total_spaces }},
                infantSpaces: {{ daycare.infant_spaces }},
                toddlerSpaces: {{ daycare.toddler_spaces }},
                preschoolSpaces: {{ daycare.preschool_spaces }},
                kindergartenSpaces: {{ daycare.kindergarten_spaces }},
                schoolageSpaces: {{ daycare.schoolage_spaces }},
                subsidy: {{ 'true' if daycare.subsidy else 'false' }},
                cwelcc: {{ 'true' if daycare.cwelcc else 'false' }},
                ageGroupLabel: "{{ daycare.age_group_label | e }}",
                ageGroupSpaces: {{ daycare.capacity }},
                website: {{ ('\"' + daycare.website + '\"') | safe if daycare.website else 'null' }},
                googleRating: {{ daycare.google_rating if daycare.google_rating else 'null' }},
                googleReviewsCount: {{ daycare.google_reviews_count if daycare.google_reviews_count else 'null' }}
            }{% if not loop.last %},{% endif %}
            {% endfor %}
        ];

        var markers = [];
        var cards = document.querySelectorAll('.profile-card');

        daycares.forEach(function(d, index) {
            var badges = '';
            if (d.cwelcc) badges += '<span style="background:#e8f4f8;color:#2e7d9a;padding:3px 8px;border-radius:4px;font-size:11px;margin-right:4px;">CWELCC</span>';
            if (d.subsidy) badges += '<span style="background:#e6f4f1;color:#0f7b6c;padding:3px 8px;border-radius:4px;font-size:11px;">Subsidy</span>';

            var ratingHtml = '';
            if (d.googleRating) {
                ratingHtml = '<span style="color:#f59e0b;font-size:13px;"><i class="fa-brands fa-google" style="color:#4285f4;margin-right:3px;"></i><i class="fa-solid fa-star"></i> ' + d.googleRating;
                if (d.googleReviewsCount) {
                    ratingHtml += ' <span style="color:#6b6b6b;">(' + d.googleReviewsCount + ')</span>';
                }
                ratingHtml += '</span><br>';
            }

            var websiteHtml = '';
            if (d.website) {
                websiteHtml = '<a href="' + d.website + '" target="_blank" rel="noopener" style="color:#2563eb;font-size:13px;text-decoration:none;"><i class="fa-solid fa-globe"></i> Website</a><br>';
            }

            var popupContent =
                '<div style="min-width:200px;font-family:-apple-system,sans-serif;">' +
                '<strong style="font-size:14px;color:#37352f;">' + d.name + '</strong><br>' +
                '<span style="color:#6b6b6b;font-size:13px;">' + d.address + '</span><br>' +
                '<span style="color:#0f7b6c;font-weight:600;font-size:13px;">' + d.distanceKm + ' km away</span><br>' +
                '<span style="color:#37352f;font-size:13px;">' + d.ageGroupSpaces + ' ' + d.ageGroupLabel + ' spots</span><br>' +
                ratingHtml +
                websiteHtml +
                '<br>' + badges +
                '</div>';

            var icon = d.cwelcc ? cwelccIcon : nonCwelccIcon;
            var marker = L.marker([d.lat, d.lon], {icon: icon})
                .addTo(map)
                .bindPopup(popupContent);

            // Click card to highlight and pan
            cards[index].addEventListener('click', function() {
                map.setView([d.lat, d.lon], 16);
                marker.openPopup();
                cards.forEach(c => c.classList.remove('highlighted'));
                this.classList.add('highlighted');
            });

            markers.push({
                marker: marker,
                cwelcc: d.cwelcc,
                index: index
            });
        });

        // Filters
        var walkingFilter = document.getElementById('filter-walking');
        var cwelccFilter = document.getElementById('filter-cwelcc');
        var resultsCount = document.getElementById('results-count');

        var filterWalkingActive = false;
        var filterCwelccActive = false;

        function parseWalkTime(walkTimeStr) {
            if (!walkTimeStr || walkTimeStr === 'N/A') return null;
            var totalMinutes = 0;
            if (walkTimeStr.includes('hour')) {
                var parts = walkTimeStr.split('hour');
                totalMinutes += parseInt(parts[0].trim()) * 60;
                walkTimeStr = parts[1] || '';
            }
            if (walkTimeStr.includes('min')) {
                var minPart = walkTimeStr.split('min')[0].trim();
                var nums = minPart.split(' ');
                totalMinutes += parseInt(nums[nums.length - 1]) || 0;
            }
            return totalMinutes > 0 ? totalMinutes : null;
        }

        function applyFilters() {
            var visibleCount = 0;

            cards.forEach(function(card, index) {
                var isCwelcc = card.dataset.cwelcc === 'true';
                var walkTime = parseWalkTime(card.dataset.walktime);
                var isWalkable = walkTime !== null && walkTime <= 15;

                var show = true;
                if (filterWalkingActive && !isWalkable) show = false;
                if (filterCwelccActive && !isCwelcc) show = false;

                card.style.display = show ? '' : 'none';

                if (markers[index]) {
                    if (show) {
                        markers[index].marker.addTo(map);
                        visibleCount++;
                    } else {
                        map.removeLayer(markers[index].marker);
                    }
                }
            });

            resultsCount.textContent = visibleCount;
        }

        walkingFilter.addEventListener('click', function() {
            filterWalkingActive = !filterWalkingActive;
            this.classList.toggle('active', filterWalkingActive);
            applyFilters();
        });

        cwelccFilter.addEventListener('click', function() {
            filterCwelccActive = !filterCwelccActive;
            this.classList.toggle('active', filterCwelccActive);
            applyFilters();
        });

        // ===== SHORTLIST FUNCTIONALITY =====
        var STORAGE_KEY = 'findMyDaycare_shortlist';
        var shortlist = [];
        var shortlistCountEl = document.getElementById('shortlist-count');
        var openShortlistBtn = document.getElementById('open-shortlist');

        function loadShortlist() {
            try {
                var stored = localStorage.getItem(STORAGE_KEY);
                if (stored) {
                    var data = JSON.parse(stored);
                    shortlist = data.daycares || [];
                }
            } catch (e) {
                shortlist = [];
            }
            updateShortlistUI();
        }

        function saveShortlist() {
            var data = {
                daycares: shortlist,
                searchAddress: searchAddress,
                savedAt: new Date().toISOString()
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
            updateShortlistUI();
        }

        function updateShortlistUI() {
            shortlistCountEl.textContent = shortlist.length;
            openShortlistBtn.classList.toggle('has-items', shortlist.length > 0);

            // Update all bookmark buttons
            document.querySelectorAll('.bookmark-btn').forEach(function(btn, index) {
                var locId = daycares[index].locId;
                var isInList = shortlist.some(function(d) { return d.locId === locId; });
                var icon = btn.querySelector('i');
                if (isInList) {
                    icon.classList.remove('fa-regular');
                    icon.classList.add('fa-solid');
                    btn.classList.add('active');
                } else {
                    icon.classList.remove('fa-solid');
                    icon.classList.add('fa-regular');
                    btn.classList.remove('active');
                }
            });
        }

        function toggleShortlist(daycare) {
            var index = shortlist.findIndex(function(d) { return d.locId === daycare.locId; });
            if (index >= 0) {
                shortlist.splice(index, 1);
            } else {
                shortlist.push(daycare);
            }
            saveShortlist();
        }

        // Attach click handlers to bookmark buttons
        document.querySelectorAll('.bookmark-btn').forEach(function(btn, index) {
            btn.addEventListener('click', function(e) {
                e.stopPropagation();
                toggleShortlist(daycares[index]);
            });
        });

        // Shortlist panel
        var shortlistPanel = document.getElementById('shortlist-panel');
        var shortlistOverlay = document.getElementById('shortlist-overlay');
        var shortlistItems = document.getElementById('shortlist-items');
        var emailInput = document.getElementById('shortlist-email');
        var sendBtn = document.getElementById('send-shortlist-btn');
        var clearBtn = document.getElementById('clear-shortlist-btn');
        var closeBtn = document.getElementById('close-shortlist-btn');
        var emailStatus = document.getElementById('email-status');

        function openShortlistPanel() {
            renderShortlistItems();
            shortlistPanel.classList.add('open');
            shortlistOverlay.classList.add('open');
        }

        function closeShortlistPanel() {
            shortlistPanel.classList.remove('open');
            shortlistOverlay.classList.remove('open');
        }

        function renderShortlistItems() {
            if (shortlist.length === 0) {
                shortlistItems.innerHTML = '<p class="empty-message">No daycares saved yet. Click the heart icon on a daycare to add it to your list.</p>';
                sendBtn.disabled = true;
                return;
            }
            sendBtn.disabled = false;
            var html = '';
            shortlist.forEach(function(d) {
                html += '<div class="shortlist-item">' +
                    '<div class="shortlist-item-info">' +
                    '<strong>' + d.name + '</strong>' +
                    '<span>' + d.address + '</span>' +
                    '</div>' +
                    '<button class="remove-btn" data-loc-id="' + d.locId + '" title="Remove">' +
                    '<i class="fa-solid fa-times"></i>' +
                    '</button>' +
                    '</div>';
            });
            shortlistItems.innerHTML = html;

            // Attach remove handlers
            shortlistItems.querySelectorAll('.remove-btn').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    var locId = parseInt(btn.dataset.locId);
                    shortlist = shortlist.filter(function(d) { return d.locId !== locId; });
                    saveShortlist();
                    renderShortlistItems();
                });
            });
        }

        openShortlistBtn.addEventListener('click', openShortlistPanel);
        closeBtn.addEventListener('click', closeShortlistPanel);
        shortlistOverlay.addEventListener('click', closeShortlistPanel);

        clearBtn.addEventListener('click', function() {
            if (confirm('Clear all saved daycares?')) {
                shortlist = [];
                saveShortlist();
                renderShortlistItems();
            }
        });

        sendBtn.addEventListener('click', function() {
            var email = emailInput.value.trim();
            if (!email) {
                emailStatus.textContent = 'Please enter your email';
                emailStatus.className = 'email-status error';
                return;
            }

            sendBtn.disabled = true;
            sendBtn.textContent = 'Sending...';
            emailStatus.textContent = '';

            fetch('/api/send-shortlist', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    email: email,
                    daycares: shortlist,
                    searchAddress: searchAddress
                })
            })
            .then(function(res) { return res.json(); })
            .then(function(data) {
                if (data.success) {
                    emailStatus.textContent = 'Email sent! Check your inbox.';
                    emailStatus.className = 'email-status success';
                    emailInput.value = '';
                } else {
                    emailStatus.textContent = data.error || 'Failed to send email';
                    emailStatus.className = 'email-status error';
                }
            })
            .catch(function() {
                emailStatus.textContent = 'Network error. Please try again.';
                emailStatus.className = 'email-status error';
            })
            .finally(function() {
                sendBtn.disabled = false;
                sendBtn.textContent = 'Send to my email';
            });
        });

        // Load shortlist on page load
        loadShortlist();
    </script>
    {% else %}
    <div class="results-main">
        <div class="no-results-card">
            <h3>No daycares found</h3>
            <p>We couldn't find daycares within {{ radius_km }}km with spaces for this age group.</p>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}
